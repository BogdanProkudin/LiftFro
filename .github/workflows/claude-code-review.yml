name: PR Review with Progress Tracking

# This example demonstrates how to use the track_progress feature to get
# visual progress tracking for PR reviews, similar to v0.x agent mode.

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  review-with-tracking:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: PR Review with Progress Tracking
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Enable progress tracking
          track_progress: true

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this PR thoroughly. Follow ALL rules from CLAUDE.md.

            ## Review Checklist

            ### üîí Security
            - Check for exposed secrets, API keys, tokens in code
            - Verify all user input is validated (Zod schemas)
            - Check auth guards on new endpoints (@UseGuards, @Public)
            - Look for SQL injection risks (raw queries with user input)
            - Check for XSS vectors (dangerouslySetInnerHTML, unescaped output)

            ### üèóÔ∏è Architecture (FSD)
            - Verify layer import rules: app‚Üípages‚Üíwidgets‚Üífeatures‚Üíentities‚Üíshared
            - Entities must NOT have mutations (only GET queries)
            - Features must NOT render complex UI (only action hooks + small buttons)
            - Widgets must NOT import from other widgets
            - Shared must NOT contain business logic
            - Check barrel exports (index.ts) on every slice

            ### üìù TypeScript
            - Flag any use of `any` type ‚Äî suggest `unknown` with type guard
            - Check for missing return types on functions
            - Verify exhaustive switch statements (no missing cases)
            - Check proper nullability handling (no `!` assertions without justification)

            ### ‚ö° Performance
            - Check for N+1 queries in Prisma (missing include/select)
            - Verify pagination on list endpoints (no unbounded arrays)
            - Look for missing `select` in Prisma queries (returning full objects)
            - Check for heavy components that should be lazy loaded

            ### üß™ Quality
            - No console.log (use logger on backend)
            - No commented-out code
            - No TODO without linked issue number
            - No hardcoded magic numbers or strings
            - New endpoints must have Swagger decorators
            - New pages must have loading.tsx and error.tsx
            - Functions >50 lines should be split
            - Components >200 lines should be split

            ### üìõ Naming Conventions
            - Files: kebab-case
            - Components: PascalCase
            - Functions/vars: camelCase
            - Constants: UPPER_SNAKE_CASE
            - Commits: Conventional Commits format
            - API endpoints: kebab-case
            - Boolean vars: is/has/can/should prefix

            ## Output Format
            For each issue found, provide:
            1. **Severity**: üî¥ Critical | üü° Warning | üîµ Suggestion
            2. **File and line reference**
            3. **What's wrong**
            4. **How to fix** (with code example if helpful)

            End with a summary: total issues by severity, overall assessment (‚úÖ Approve / ‚ö†Ô∏è Changes Requested / üî¥ Block).

            IMPORTANT: You MUST return a structured output with your verdict. Use FAIL if any üî¥ Critical issues exist.

          # Tools for comprehensive PR review
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
            --model claude-sonnet-4-5-20250929
            --json-schema '{"type":"object","properties":{"verdict":{"type":"string","enum":["PASS","FAIL"]},"critical_count":{"type":"integer"},"high_count":{"type":"integer"},"summary":{"type":"string"}},"required":["verdict","critical_count","high_count","summary"]}'

      - name: Check review result
        env:
          REVIEW_OUTPUT: ${{ steps.claude-review.outputs.structured_output }}
        run: |
          echo "Review output: $REVIEW_OUTPUT"
          VERDICT=$(echo "$REVIEW_OUTPUT" | jq -r '.verdict')
          CRITICAL=$(echo "$REVIEW_OUTPUT" | jq -r '.critical_count')
          HIGH=$(echo "$REVIEW_OUTPUT" | jq -r '.high_count')
          SUMMARY=$(echo "$REVIEW_OUTPUT" | jq -r '.summary')
          echo "Verdict: $VERDICT | Critical: $CRITICAL | High: $HIGH"
          echo "Summary: $SUMMARY"
          if [ "$VERDICT" = "FAIL" ]; then
            echo "‚ùå Claude review found $CRITICAL critical and $HIGH high severity issues. Blocking merge."
            exit 1
          fi
          echo "‚úÖ Claude review passed."
